{% extends 'base.html' %}
{% load static %}

{% block title %}
Posts
{% endblock title %}


{% block content %}

<div class="row" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
        <div class="col-md-8">

            {% for post in posts_qs %}
                <h4>{{post.author}}</h4><br>
                {{post.created|timesince}} ago <br>
                {% ifequal request.user post.author.user %}
                    <a href="{% url 'update-post' post.pk %}"><button class="btn btn-dark">Update</button></a>&nbsp;&nbsp;
                    <a href="{% url 'delete-post' post.pk %}"><button class="btn btn-dark">Delete</button></a>&nbsp;&nbsp;
                {% endifequal %}
                <br>
<!--                <img src="post.image.url" alt="post image">-->
                <p>{{post.content}}</p><br>

                <form method="post" action="{% url 'like-unlike-post' %}" class="like-unlike-form" id="{{post.id}}">
                    {% csrf_token %}
                    <input type="hidden" name="post_id" value="{{post.id}}">

                    <button type="submit" class="btn btn-primary like-unlike-btn-{{post.id}}">
                        {% if profile not in post.liked_by.all %}
                        Like
                        {% else %}
                        Unlike
                        {% endif %}
                    </button>
                </form>

                Total likes: <div class="like-unlike-count-{{post.id}}">{{post.likes}}</div>

                {% if post.comment_set.exists %}
                <button class="btn btn-secondary" id="comments-toggle-btn">Show/Hide comments</button>
<!--                <div class="row" style="border:solid black 1px;">-->
<!--                    <div id="comment-box" class="col-md-4">-->
                    <section id="comment-box" style="display:none">
                    <h4>Comments</h4>

                        {% for comment in post.comment_set.all %}
                            <p><strong>{{comment.user}}</strong> ---> {{comment.body}}</p><br>
                        {% endfor %}

                    {% endif %}
                    </section>
<!--                    </div>-->
<!--                </div>-->


                <form action="{% url 'submit-new-comment' %}" method="post">
                    {% csrf_token %}
                    {{new_comment_form.as_p}}
                    <input type="hidden" name="post_id" value="{{post.id}}">
                    <button type="submit" class="btn btn-success">Comment</button>
                </form>
                <hr>
            {% endfor %}

        </div>

        <div class="col-md-4" style="border-left: groove">

            <h1>Create a post</h1>
            <hr>
            <form action="{% url 'create-post' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {{new_post_form.as_p}}
                <button type="submit" class="btn btn-secondary">Post</button>
            </form>

        </div>

    </div>


{% endblock content %}


{% block scripts %}
<script>
    $(document).ready(function() {
        button = document.getElementById('comments-toggle-btn');
        button.addEventListener("click", function () {
            comment_box = document.getElementById('comment-box');
            if (comment_box.style.display == "none")
            {
                comment_box.style.display = "block";
            }
            else <!-- if (comment_box.style.display == "block") -->
            {
                comment_box.style.display = "none"
            }
        });

        $('.like-unlike-form').submit(function(e) {
            e.preventDefault()

            // Get the post-id from the form-id.
            const post_id = $(this).attr('id')

            // Get the text on the button, i.e., 'Like'/'Unlike'.
            const text = $(`.like-unlike-btn-${post_id}`).text()
            const btn_text = $.trim(text)

            // Get the url.
            const url = $(this).attr('action')

            // Get the likes count.
            let result;
            const raw_likes_count = $(`.like-unlike-count-${post_id}`).text()
            const likes_count = parseInt(raw_likes_count)

            // Ajax part - Initial part of ajax code below sends the request and data
            // to the function defined in views.py, i.e., the server. Then the later
            // part receives the Json response and renders it to the front end.
            $.ajax({
                type: 'POST',
                url: url,
                data: {
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                    'post_id': post_id
                },

                success: function(response) {
                    // Gets Json response.
                    if (btn_text === 'Unlike')
                    {
                        $(`.like-unlike-btn-${post_id}`).text('Like')
                        result = likes_count - 1
                    }
                    else
                    {
                        $(`.like-unlike-btn-${post_id}`).text('Unlike')
                        result = likes_count + 1
                    }
                    $(`.like-unlike-count-${post_id}`).text(result)
                },
                error: function(response) {
                    // Error.
                    console.log('Error', response)
                }
            })
        });
    });
</script>
{% endblock scripts %}
